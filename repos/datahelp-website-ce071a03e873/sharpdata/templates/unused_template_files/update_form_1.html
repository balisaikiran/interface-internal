{% load static %}

<head>
  <link
    href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    rel="stylesheet"
  />
  <link
    href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    crossorigin="anonymous"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.css"
    integrity="sha512-63+XcK3ZAZFBhAVZ4irKWe9eorFG0qYsy2CaM5Z+F3kUn76ukznN0cp4SArgItSbDFD1RrrWgVMBY9C/2ZoURA=="
    rel="stylesheet"
  />
  <link
    crossorigin="anonymous"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css"
    integrity="sha512-aEe/ZxePawj0+G2R+AaIxgrQuKT68I28qh+wgLrcAJOz3rxCP+TwrK5SPN+E5I+1IQjNtcfvb96HDagwrKRdBw=="
    rel="stylesheet"
  />
  <link
    crossorigin="anonymous"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker-standalone.css"
    integrity="sha512-2e0Kl/wKgOUm/I722SOPMtmphkIjECJFpJrTRRyL8gjJSJIP2VofmEbqyApMaMfFhU727K3voz0e5EgE3Zf2Dg=="
    rel="stylesheet"
  />
  <link
    crossorigin="anonymous"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker-standalone.min.css"
    integrity="sha512-tjNtfoH+ezX5NhKsxuzHc01N4tSBoz15yiML61yoQN/kxWU0ChLIno79qIjqhiuTrQI0h+XPpylj0eZ9pKPQ9g=="
    rel="stylesheet"
  />
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    rel="stylesheet"
  />

  <style>
    /* Just makin' it look nice. */
    body {
      background: #00008b;
      min-height: 600px;
    }

    .conditional {
      margin: 1em 0 0.5em;
      border-top: 2px dotted #eee;
      padding-top: 1em;
      color: rgba(0, 0, 0, 0.7);
      font-size: 0.9em;
    }

    .conditional > .conditional {
      color: rgba(0, 0, 0, 0.5);
    }

    #demo {
      text-align: left;
      padding: 1.5em 3em;
      background: #fff;
      width: 100%;
      margin: 2em auto;
      border-radius: 0.5em;
      font: 18px/22px "Open Sans", Arial, Verdana, serif;
    }

    /* label+label {
            margin-left: 1em;
        } */
    label {
      white-space: pre-wrap;
    }

    input + span {
      position: absolute;
      left: 0;
      top: 4px;
      width: 15px;
      height: 15px;
      border: 2px solid #6ab5a8;
    }
    

    input[type="radio"] + span {
      border-radius: 50%;
    }

    input[type="radio"]:checked + span {
      background: rgba(106, 181, 169, 1);
      background: -moz-radial-gradient(
        center,
        ellipse cover,
        rgba(106, 181, 169, 1) 44%,
        rgba(255, 255, 255, 1) 45%,
        rgba(255, 255, 255, 1) 46%,
        rgba(255, 255, 255, 1) 55%
      );
      background: -webkit-gradient(
        radial,
        center center,
        0px,
        center center,
        100%,
        color-stop(44%, rgba(106, 181, 169, 1)),
        color-stop(45%, rgba(255, 255, 255, 1)),
        color-stop(46%, rgba(255, 255, 255, 1)),
        color-stop(55%, rgba(255, 255, 255, 1))
      );
      background: -webkit-radial-gradient(
        center,
        ellipse cover,
        rgba(106, 181, 169, 1) 44%,
        rgba(255, 255, 255, 1) 45%,
        rgba(255, 255, 255, 1) 46%,
        rgba(255, 255, 255, 1) 55%
      );
      background: -o-radial-gradient(
        center,
        ellipse cover,
        rgba(106, 181, 169, 1) 44%,
        rgba(255, 255, 255, 1) 45%,
        rgba(255, 255, 255, 1) 46%,
        rgba(255, 255, 255, 1) 55%
      );
      background: -ms-radial-gradient(
        center,
        ellipse cover,
        rgba(106, 181, 169, 1) 44%,
        rgba(255, 255, 255, 1) 45%,
        rgba(255, 255, 255, 1) 46%,
        rgba(255, 255, 255, 1) 55%
      );
      background: radial-gradient(
        ellipse at center,
        rgba(106, 181, 169, 1) 44%,
        rgba(255, 255, 255, 1) 45%,
        rgba(255, 255, 255, 1) 46%,
        rgba(255, 255, 255, 1) 55%
      );
      filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#6ab5a9', endColorstr='#ffffff', GradientType=1);
    }

    input[type="checkbox"]:checked + span:after {
      content: "\00d7";
      font-weight: bold;
      position: absolute;
      top: -7px;
      left: 1px;
      font-size: 20px;
      color: #6ab5a8;
    }

    input[type="radio"],
    input[type="checkbox"] {
      /*hide the radio button*/
      filter: alpha(opacity=0);
      -moz-opacity: 0;
      -khtml-opacity: 0;
      opacity: 0;
    } 

    select,
    input[type="text"], input[type="number"], input[type="date"], select {
      border-radius: 5px !important;
      padding: 6px 10px !important;
      border: 2px solid #00008b !important;
      color: #666 !important;
      font-size: 15px !important;
      width: 65% !important;
    }
    .error_message{
      color: red;
    }

    .currency-wrap {
      position: relative;
      margin-bottom: 10px;
    }

    .currency-code {
      display: none;
      position: absolute;
      left: 8px;
      top: 8px;
    }

    .number-currency {
      border-radius: 5px;
      padding: 6px 19px;
      border: 2px solid #00008b;
      color: #666;
      font-size: 15px;
      width: 65%;
    }

    .percent-code {
      position: absolute;
      left: 58%;
      top: 8px;
    }

    .number-price {
      border-radius: 5px;
      padding: 6px 10px;
      border: 2px solid #00008b;
      color: #666;
      font-size: 15px;
      width: 65%;
    }

    .zip-code {
      border-radius: 5px;
      padding: 6px 10px;
      border: 2px solid #00008b;
      color: #666;
      font-size: 15px;
      width: 65%;
      padding-left: 9px;
    }
    .reqField{
      font-size: 8px; 
      color: red;
    }
    .missingField{
      color: red !important;
    }
    .readonly{
      pointer-events: none;
    }
    /* .option_fields{
      display: none;
    } */
  </style>
  
</head>

<body>
  <div id="demo">
    <form method="POST" id="common_form">
      <div class="row">
        <div>
          <a
          class="mt-4 btn btn-primary"
          style="float: left;"
          title="Back to list"
          href="{% url 'list_view' %}?context={{context_data}}&signature={{signature}}"
        >
        <i title="Terminate Transaction" class="fa-solid fa-arrow-left "></i>
        Back
      </a>
        </div>
        {% if opp_stage != "Terminated" %}
          <a
            id="terminate_toggle_btn"
            class="select-terminate mt-4 btn btn-danger"
            style="float: right;"
            type="submit"
            value="submit"
            title="Terminate Transaction"
          >
          Terminate
          <i title="Terminate Transaction" class="fa-solid fa-ban"></i>
        </a>
      {% endif %}
    </div>
        
      {% csrf_token %} 
      <input hidden name="fub_deal_id" value="{{fub_deal_id}}" />
      <input hidden name="previous_fub_deal_stage_name" value="{{opp_stage}}" />
      <input hidden name="domain" value="{{domain}}" />
      <input hidden name="appt_set_entry_id" value="{{appt_set_entry_id}}" />
      <input hidden name="appt_set_lead_type" value="{{appt_set_lead_type}}" />
      <input hidden name="appt_set_platform" value="{{appt_set_platform}}" />
      <input hidden name="previous_opp_type" value="{{opp_type}}" />

      <input hidden name="domain" value="{{domain}}" />
      <div>
        <!-- <h3 style="text-align: center">Update transaction</h3> -->
        <br />
        {% if opp_stage != "Terminated" %}
        <div>
          <h3 style="text-align: center">
            Update Transaction: {{opp_type}} - {{opp_last_name}} <br />
            <div style="margin-top: 1%">
              <a
                href="https://my.sisu.co/transactions/edit/{{sisu_client_id}}"
                target="_blank"
              >
                <button class="btn btn-primary btn-lg center-btn" type="button">
                  View Sisu Client
                </button>
              </a>
            </div>
          </h3>
          <br />
  
          {% if opp_stage == "Appointment Set" %}
          <label>Appointment Disposition:</label><br />
          {% else %}
  
          <label>Stage:</label> <br />
          {% endif %}
        <br />
        <div class="form-group">
        <select id="stage_select" class="form-control select float-right common-fields" name="opp_stage" required>
            <option value="">Pick one!</option>
            {% if opp_stage == "Pipeline" %}
            <option id="Appointment Set" value="Appointment_Set">Appointment Set</option>
            <option id="Agreement Signed" value="Agreement_Signed">Agreement Signed</option>
            <option id="Pending" value="Pending">Pending</option>
            <option id="Closed" value="Closed">Closed</option>
            {% elif opp_stage == "Appointment Set" %}
            <option id="Appointment Met" value="Appointment_Met">
              Appointment Met
            </option>
            <option id="Appointment Missed" value="Appointment_Missed">
              Appointment Missed
            </option>
            {% elif opp_stage == "Appointment Met" %}
            <option id="Agreement Signed" value="Agreement_Signed">
              Agreement Signed
            </option>
            <option id="Pending" value="Pending">Pending</option>
            <option id="Closed" value="Closed">Closed</option>
            {% elif opp_stage == "Agreement Signed" %}
            <option id="Pending" value="Pending">Pending</option>
            <option id="Closed" value="Closed">Closed</option>
            {% elif opp_stage == "Pending" %}
            <option id="Closed" value="Closed">Closed</option>
            <option id="Pending Cancelled" value="Pending Cancelled">Pending Cancelled</option>
            
            {% endif %}
            <option hidden id="Terminated" value="Terminated">Terminated</option>
        </select>
      </div>
        <!-- <script>document.getElementById("{{stageName}}").selected = true;</script> -->

        <!-- <div class="form-group">   
          <label>Assigned OSA</label>
          <sup><i class="fa fa-asterisk reqField"></i></sup>
          <select class="form-control select float-right common-fields" name="opp_assigned_osa" required>
            <option value="" selected>Pick one!</option>
            {% for item in osa_list %}
            <option id="{{item.name}}" value="{{item.name}}">
              {{item.name}}
            </option>
            {% endfor %}
          </select>
        </div> -->

        <!-- <div class="form-group">
          <label>Description </label><br />
          <textarea
            class="number-price form-control"
            id="opp_notes"
            name="opp_notes"
            placeholder=""
            type="text"
          ></textarea>
        </div> -->
        <!-- {% if description %}
        <script>
          document.getElementById("opp_notes").value = {{ description}}
        </script>
        {% endif %} -->
      </div>
      {% else %}
      <div>
        <h3 style="text-align: center;">Terminated Transaction: {{opp_type}} - {{opp_last_name}}
          <br> <div style="margin-top: 1%">
              <a class="btn btn-primary btn-lg float-right" onclick='location.href = "{% url 'list_view' %}?context={{context_data}}&signature={{signature}}"' >Back</a>
      </div>
      </h3>
      </div> 
      {% endif %}
        

    <div id="main_box">
    </div>
      <div class="form-actions form-group mt-3">
        <div id="pendingFields">

        </div>
        <button
          id="btnSubmit"
          class="btn btn-primary btn-lg float-right mt-4"
          type="submit"
          value="submit">
          Submit
        </button>
      </div>

    </form>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script
    src="https://eia.followupboss.com/embeddedApps-v1.0.0.js"
    type="text/javascript"
  ></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="{% static 'js/conditionize.flexible.jquery.js' %}"></script>
  <script src="https://kit.fontawesome.com/6c7e0274d0.js" crossorigin="anonymous"></script>

  <script>
    $(function () {
      $(".datePicker").datepicker();
    });
  </script>

  <script>
    /* * * * * * * * * * * * * * * * * *
     * Show/hide fields conditionally
     * * * * * * * * * * * * * * * * * */
    (function ($) {
      $.fn.conditionize = function (options) {
        var settings = $.extend(
          {
            hideJS: true,
          },
          options
        );

        $.fn.showOrHide = function (listenTo, listenFor, $section) {
          if (
            $(listenTo).is("select, input[type=text]") &&
            $(listenTo).val() == listenFor
          ) {
            $section.slideDown();
          } else if ($(listenTo + ":checked").val() == listenFor) {
            $section.slideDown();
          } else {
            $section.slideUp();
          }
        };

        this.each(function () {
          var listenTo = "[name=" + $(this).data("cond-option") + "]";
          var listenFor = $(this).data("cond-value");
          var $section = $(this);

          //Set up event listener
          $(listenTo).on("change", function () {
            $.fn.showOrHide(listenTo, listenFor, $section);
          });
          //If setting was chosen, hide everything first...
          if (settings.hideJS) {
            $(this).hide();
          }
          //Show based on current value on page load
          $.fn.showOrHide(listenTo, listenFor, $section);
        });
      };
    })(jQuery);


    $(document).ready(function(){
    

      function make_api_call(URL, TYPE, payload={} ){
            return new Promise((resolve, reject) => {
              $.ajax({
                url: URL,
                type: TYPE,
                data: payload,
                success: function (data) {
                  console.log(data);
                  resolve(data)
                },
                error: function (error) {
                  console.log(error);
                  reject(error)
                },
              })
            })
          }
        var jsonInput;
        var isa_list = String.raw`{{isa_list |safe}}`;
        var prev_data = String.raw`{{opp_prev_data | safe}}`;
        var osa_list = String.raw`{{osa_list|safe}}`;

        make_api_call("{% url 'update_form_fields' %}", "GET", {"isa_list":isa_list, "data": prev_data, "osa_list": osa_list}).then(response => {
            jsonInput = response;
            console.log("response", response);
        });


      function createSelectField(label, name, value=[], selected, required=false,  readonly=false){
          var options ="";
          for(v in value){
            options +=`<option value="${value[v]}" ${value[v] == selected?"selected":""} >${value[v]}</option>`;
          }
          options +=`<option disabled value="null">Pick one!</option>`

          var base = `<div class="form-group ${name} option_fields ${required == 'true'?"requiredAttr" : ""}">
                        <label for="">${label}</label>
                          ${required == 'true' ?'<sup> <i class="fa fa-asterisk reqField"></i></sup>':''}
                        <select name="${name}" class="form-control ${readonly == 'true'?'readonly' : ''}" ${required == 'true'?"required" : ""} ${readonly == 'true'?"readonly" : ""}>
                          ${options}
                        </select>
                      </div>`;
          return base;
        }

      function createInputField(label, name, type, classes, value="", required=false, step, readonly=false){
        console.log("readonly", readonly);
        console.log("value", value);
        if (value == null || value == "null"){
          value = ""
        }
          var base = `<div class="form-group ${name} option_fields ${required == 'true'?"requiredAttr" : ""}">
            <label>${label}</label>
            ${required == 'true' ?'<sup> <i class="fa fa-asterisk reqField"></i></sup>':''}
            <div class="">
              <input
                class="form-control ${classes} ${readonly == 'true' && value? 'readonly': ''}"
                name="${name}"
                step="${step!=''?step="any":''}"
                type="${type}"
                value="${value}"
                ${readonly == 'true' && value ? 'readonly': ''}
              />
            </div></div>`;
            return base
        }

      function createTextArea(label, name, type, classes, value="", required=false, readonly=false) {
        if (value == null || value == "null"){
          value = ""
        }
        var base = `<div class="form-group ${name} option_fields ${required == 'true'?"requiredAttr" : ""}">
            <label>${label}</label>
            ${required == 'true' ?'<sup> <i class="fa fa-asterisk reqField"></i></sup>':''}
            <div class="">
              <textarea
                class="form-control ${classes} ${readonly == 'true' && value? 'readonly': ''}"
                name="${name}"
                rows="4" 
                cols="35"
                value="${value}"
                ${readonly == 'true' && value? 'readonly': ''}
              />
              ${value}
            </textarea>
            </div></div>`;
            return base
      }
  
      function createTimeField(label, name, required=false, steps = 15, readonly=false) {
        var selectOptions='<option value="" disabled selected>Select Time</option>';
        var hours, minutes, ampm;
        for(var i = 420; i <= 1320; i += steps){
            hours = Math.floor(i / 60);
            minutes = i % 60;
            if (minutes < 10){
                minutes = '0' + minutes; // adding leading zero
            }
            ampm = hours % 24 < 12 ? 'AM' : 'PM';
            hours = hours % 12;
            if (hours === 0){
                hours = 12;
            }
            selectOptions += `<option value="${hours}:${minutes} ${ampm}">${hours}:${minutes} ${ampm}</option>`;
        }
        var base = `<div class="form-group ${name} option_fields ${required == 'true'?"requiredAttr" : ""}">
                      <label for="">${label}</label>
                      ${required == 'true' ?'<sup> <i class="fa fa-asterisk reqField"></i></sup>':''}
                      <select name="${name}" class="form-control" >
                        ${selectOptions}
                      </select>
                    </div>`;

        return base;
      }

      var defaultstates = [{"United States":{"AK":"Alaska","AL":"Alabama","AR":"Arkansas","AS":"American Samoa","AZ":"Arizona","CA":"California","CO":"Colorado","CT":"Connecticut","DC":"District of Columbia","DE":"Delaware","FL":"Florida","GA":"Georgia","GU":"Guam","HI":"Hawaii","IA":"Iowa","ID":"Idaho","IL":"Illinois","IN":"Indiana","KS":"Kansas","KY":"Kentucky","LA":"Louisiana","MA":"Massachusetts","MD":"Maryland","ME":"Maine","MI":"Michigan","MN":"Minnesota","MO":"Missouri","MP":"Northern Mariana Islands","MS":"Mississippi","MT":"Montana","NA":"National","NC":"North Carolina","ND":"North Dakota","NE":"Nebraska","NH":"New Hampshire","NJ":"New Jersey","NM":"New Mexico","NV":"Nevada","NY":"New York","OH":"Ohio","OK":"Oklahoma","OR":"Oregon","PA":"Pennsylvania","PR":"Puerto Rico","RI":"Rhode Island","SC":"South Carolina","SD":"South Dakota","TN":"Tennessee","TX":"Texas","UT":"Utah","VA":"Virginia","VI":"Virgin Islands","VT":"Vermont","WA":"Washington","WI":"Wisconsin","WV":"West Virginia","WY":"Wyoming"}},{"Canada":{"AB":"Alberta","BC":"British Columbia","MB":"Manitoba","NB":"New Brunswick","NL":"Newfoundland and Labrador","NT":"Northwest Territories","NS":"Nova Scotia","NU":"Nunavut","ON":"Ontario","PE":"Prince Edward Island","QC":"Quebec","SK":"Saskatchewan","YT":"Yukon"}}]
      
      function createStateField(label, name, states=[], value_selected, required=false, readonly=false){
          var group="";
          var not_found = true;
          for(i in states){
            var options="";
            var obj = states[i];
          Object.keys(obj).map(function(m){
            Object.keys(obj[m]).map(function(k){
              options +=`<option value="${k}" ${k == value_selected?"selected":""}>${obj[m][k]}</option>`;
              if (k == value_selected){
                not_found = false
              }
            })
            group += `<optgroup label="${m}">${options}</optgroup>`;
          })
          }

          group += `<option disabled value="null" ${not_found?"selected":""}>Pick one!</option>`;

          var base = `<div class="form-group ${name} option_fields ${required == 'true'?"requiredAttr" : ""}">
            <label for="">${label}</label>
            ${required == 'true' ?'<sup> <i class="fa fa-asterisk reqField"></i></sup>':''}
            <select name="${name}" class="form-control" >
              ${group}
            </select>
          </div>`;

        return base;
      }
          
      function runJs(js){
        console.log(js);
        setTimeout(()=>{
          eval(js)
        console.log("Loaded JS");
        }, 700)
        
      }


      function activateFields(fields=[]) {
        console.log("fields", fields);
        $("#main_box").empty();
        var blocks;
        if(fields){
          
          for(sno in fields){
            if(fields[sno]["type"] == "select"){
              blocks = createSelectField(
                fields[sno]["label"],
                fields[sno]["field"],
                fields[sno]["data"].split(","),
                fields[sno]["value"],
                fields[sno]["required"],
                fields[sno]["readonly"]
                
                );
                console.log(fields[sno]["condition"]);
                runJs(fields[sno]["condition"])
            }
            else if(fields[sno]["type"] == "time"){
              blocks = createTimeField(
                fields[sno]["label"],
                fields[sno]["field"],
                fields[sno]["required"],
                30
              );
              runJs(fields[sno]["condition"])
            }
            else if(fields[sno]["type"] == "state"){
              blocks = createStateField(
                fields[sno]["label"],
                fields[sno]["field"],
                defaultstates,
                fields[sno]["value"],
                fields[sno]["required"],
              );
              runJs(fields[sno]["condition"])
            }
            else if(fields[sno]["type"] == "textarea"){
                blocks = createTextArea(
                fields[sno]["label"],
                fields[sno]["field"],
                dataType,
                extraClasses,
                fields[sno]["value"],
                fields[sno]["required"],
                fields[sno]["readonly"]
              )
              runJs(fields[sno]["condition"])

            }
            else{
              var dataType;
              var inpType;
              var extraClasses="";
              var step="";
              

              if(fields[sno]["type"] == "number")
              {
                console.log("Number");
                dataType = "number";
                step = "any";
                classes="number-currency"
              }
              else if(fields[sno]["type"] == "date")
              {
                console.log("date");
                extraClasses = "datePicker"
                dataType = "date";
              }
              else if(fields[sno]["type"] == "tel"){
                console.log("phone");
                dataType = "number";
              }
              else{
                console.log("text");
                dataType = "text";
                
              }
              
              blocks = createInputField(
                fields[sno]["label"],
                fields[sno]["field"],
                dataType,
                extraClasses,
                fields[sno]["value"],
                fields[sno]["required"],
                step,
                fields[sno]["readonly"]
                );
                runJs(fields[sno]["condition"])
            }
            $("#main_box").append(blocks)
          }
        }
      }

      function restAllFields(){
        $(".option_fields").hide();
        $(".option_fields :input").prop("disabled", true);
        $(".option_fields > select").prop("disabled", true);
      }

      $("#stage_select").on("change", function(){
        restAllFields()
        var selected_data = jsonInput[$(this).val()];
        console.log("selected_data", selected_data);
        activateFields(fields = selected_data)
      })

      function removeRequiredFromHidden(){
        $(".form-group").each((no, atr)=>{
          if($(atr).is(":hidden")){
            $(atr).find("input").find("select").removeAttr("required")
          }
          else{
              if($(atr).children("sup").length > 0){
                $(atr).find("input").find("select").prop("required", "required")
            }
          }
        })  
      }


      function onChange(changeClass="", on="change", condition={}, initialHiddenClasses=[])
      {
        if(initialHiddenClasses){
        var hiddenClasses = "."+initialHiddenClasses.join(', .')
        console.log("hiddenClasses", hiddenClasses);
        $(hiddenClasses).hide();}
 
        condition = JSON.parse(condition);
        if(changeClass && condition){
          $(changeClass).on(on, function(){
          var $this = $(this).val();
          if(condition.hasOwnProperty($this))
          {
            var classes = "."+condition[$this]["classes"].join(', .');
            console.log(condition[$this]["display"]);
            if(condition[$this]["display"] == true){
              $(classes).show();
            }else $(classes).hide()
          }
        })
        }
        removeRequiredFromHidden();
      }
})
  </script>
  <script>
    $(document).ready(function () {
      var __terminate_status = false;
      $("#common_form").submit(function (e) {
      var RequireField = []
      $(".requiredAttr").map(function(x,y){
        $(y).find("label").removeClass("missingField");
        if($(y).is(":hidden")){
          console.warn("HIDDEN FIELD", $(y).find("label").text());
        }
        else{
          if($(y).find("select").val() == null && $(y).find("select").val() != undefined){

              $(y).find("label").addClass("missingField");
            RequireField.push($(y).find("label").text());
        }
        if(String($(y).find("input").val()).length == 0){
          $(y).find("label").addClass("missingField");
            RequireField.push($(y).find("label").text());
        }
      }
    }
    )
    sortedRequireField = RequireField.filter(function(item, pos) {
    return RequireField.indexOf(item) == pos;
})

  if(sortedRequireField.length > 0 && __terminate_status == false){
    e.preventDefault();
    var err_message="";
    filterReqFieldName = []
    for(let i of sortedRequireField){
      i && filterReqFieldName.push(i);}
    
    filterReqFieldName.forEach((i,v)=>{
      err_message += `<p><small class="error_message">* ${i} is missing</small></p>`;
    })
    $("#pendingFields").empty();
    $("#pendingFields").append(err_message);
  }
  else{
    $("#btnSubmit").attr("disabled", true);
  }
    return true;
  });
  });


  // Terminate Button
  const updateDiv = ("#update");
  const targetDiv = ("#show"); 
  const terminate_btn = document.getElementById("terminate_toggle_btn");
  $("#terminate_toggle_btn").click(function(){
    if($(this).css("display") == "block"){

      $('#stage_select').val('Terminated');
        
      if(!$(".opp_notes").hasClass("opp_notes")){
      var note_field =` <div class="opp_notes">
              <label for="">Notes</label>
              <textarea class="form-control mb-3" required="true" placeholder="Note" name="opp_notes" rows="4" cols="35"></textarea>
            </div>`;
      $("#main_box").append(note_field)
    }
      $(this).attr("type", "back");
      if($(this).attr("type") == "submit")
        $(this).html(`Terminate <i title="Terminate Transaction" class="fa-solid fa-ban"></i>`)

      else{
        $(this).html('<i class="fa-solid fa-angle-left"></i> Back');
        $(this).attr("onclick",`location.href = "{% url 'list_view' %}?context={{context_data}}&signature={{signature}}"`);
      } 
      __terminate_status = true;
    }
  })
</script>
</body>
