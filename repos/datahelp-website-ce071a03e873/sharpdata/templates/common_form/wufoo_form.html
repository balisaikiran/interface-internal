<!DOCTYPE html>
{% load static %}

<head>

    <!-- Fonts CDN -->
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous" />


    <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">

    <link crossorigin="anonymous"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.css"
        integrity="sha512-63+XcK3ZAZFBhAVZ4irKWe9eorFG0qYsy2CaM5Z+F3kUn76ukznN0cp4SArgItSbDFD1RrrWgVMBY9C/2ZoURA=="
        rel="stylesheet" />
    <link crossorigin="anonymous"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css"
        integrity="sha512-aEe/ZxePawj0+G2R+AaIxgrQuKT68I28qh+wgLrcAJOz3rxCP+TwrK5SPN+E5I+1IQjNtcfvb96HDagwrKRdBw=="
        rel="stylesheet" />
    <link crossorigin="anonymous"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker-standalone.css"
        integrity="sha512-2e0Kl/wKgOUm/I722SOPMtmphkIjECJFpJrTRRyL8gjJSJIP2VofmEbqyApMaMfFhU727K3voz0e5EgE3Zf2Dg=="
        rel="stylesheet" />
    <link crossorigin="anonymous"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker-standalone.min.css"
        integrity="sha512-tjNtfoH+ezX5NhKsxuzHc01N4tSBoz15yiML61yoQN/kxWU0ChLIno79qIjqhiuTrQI0h+XPpylj0eZ9pKPQ9g=="
        rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">


    <style>
        * {
            box-sizing: border-radius;
            font-family: "poppins" !important;
        }

        .l-line {
            margin-left: 20px;
            transform: rotate(-24deg);

        }

        .r-line {
            margin-right: 20px;
            transform: rotate(24deg);

        }

        body {
            font-size: 13px;
            font-family: "poppins" !important;
            min-height: 400px;
            /* Added as bugfix */
            overflow-x: hidden;
            overflow-y: visible;
        }

        :root {
            --background-color: #eeeef5;
            --primary: #065697;
            --primary-hover: #065697;
        }

        .bd {
            border: solid red 1px !important;
        }

        a {
            cursor: pointer;
        }

        a:hover {
            color: inherit;
        }

        .bg-color-1 {
            background: #F9F9F9;
        }

        .pointer {
            cursor: pointer;
        }

        img {
            object-fit: cover;
        }

        .btn-primary {
            background-color: var(--primary);
            font-size: 14px;
            border-color: var(--primary);
            color: #fff;
            outline: none !important;
        }

        .btn-primary:hover,
        .btn-primary:focus,
        .btn-primary:active {
            background-color: transparent;
            border-color: var(--primary-hover);
            color: #065697;
            outline: 0px !important;
        }

        .btn-primary-outline {
            background-color: transparent;
            border-color: var(--primary);
            color: var(--primary);
            outline: 0px !important;
        }

        .btn-primary-outline:hover,
        .btn-primary-outline:focus,
        .btn-primary-outline:active {
            background-color: var(--primary);
            border-color: var(--primary);
            color: #ffffff;
            outline: 0px !important;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        .opp-type-select {
            height: 30px;
            text-align: center;
        }

        button:disabled{
            background: #9EBDD5 !important;
            border: none;
        }
    </style>
</head>


<body class="bg-white">

    <div id="loader" style="display: none;">
        {% include "common_form/loader.html" %}
    </div>
    <div id="demo" class="p-4">

        <div class=" d-flex justify-content-between align-items-center" id="back_button">
            <img src="https://fs.hubspotusercontent00.net/hub/21128156/hubfs/Interface-dark-logo.png?width=108&height=108"
                width="45">

            <b class="text-decoration-underline text-dark pointer"><i class="iconify"
                    data-icon="material-symbols:arrow-back-rounded"> </i> <a
                    onclick="showLoaderOnClick('{% url 'list_view' %}?context={{context_data}}&signature={{signature}}')">
                    Go back </a></b>
        </div>

        <hr class="hr">

        <div class=" d-flex justify-content-center text-center mb-2">
            <div>
                <div class="modal" data-bs-backdrop="static" data-bs-keyboard="false" id="opp_modal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">New deal creation confirmation</h5>
                            </div>
                            <div class="modal-body">
                                <p>A Buyer/Seller Opportunities already exist are you sure you want to make a new one?
                                </p>
                            </div>
                            <div class="modal-footer">

                                <button type="button" id="modal-back-btn" class="btn btn-secondary" onclick="existing_opp_redirect()">Take
                                    me <br />back to old deal</button>
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Iâ€™m sure,
                                    <br />Create new deal</button>
                            </div>
                        </div>
                    </div>
                </div>
                <b class="fs-6">Create New Opportunities</b>
                <p>Select the Stage</p>
            </div>
        </div>

        <form method="POST" class="mb-5">
            {% csrf_token %}
            {% if deal_id %}
            <input hidden name="deal_id" value="{{deal_id}}">
            <input hidden name="appt_set_entry_id" value="{{appt_set_entry_id}}">
            <input hidden name="appt_set_lead_type" value="{{appt_set_lead_type}}">
            <input hidden name="appt_set_platform" value="{{appt_set_platform}}">
            {% endif %}
            <input hidden name="domain" value="{{domain}}">

            <div class="opp-type-select mb-3">
                <!-- <label class="">Opportunity Type:</label> -->
                <select id="opp_type" name="opp_type" required>
                    <option selected disabled>Select Opportunity Type</option>
                    <option value="Buyer">Buyer</option>
                    <option value="Seller">Seller</option>
                    <option value="BuyerSeller">BuyerSeller</option>
                </select>
            </div>
            <div class="d-flex">

                <img height="250" class="l-line" src="{% static 'img/line.png' %}">

                <!-- <script>document.getElementById("{{stageName}}").selected = true;</script> -->
                <div class="form-actions col form-group text-center">
                    {% if pipeline_url %}
                    <p>
                        <a href="{{pipeline_url}}" target="_blank" class="btn-link" id="pipeline-link-btn">
                            <button class="btn btn-primary col-12 center-btn" type="button">Pipeline
                            </button>
                        </a>
                    </p>
                    {% endif %}
                    <p>
                        <a href="{{appt_set_url}}" target="_blank" class="btn-link" id="appo-set-link-btn">
                            <button class="btn btn-primary col-11 center-btn" type="button">Appointment Set
                            </button>
                        </a>
                    </p>
                    <p>

                        <a href="{{agreement_signed_url}}" target="_blank" class="btn-link" id="agreement-signed-link-btn">
                            <button class="btn btn-primary col-10 center-btn" type="button">Agreement Signed
                            </button>
                        </a>
                    </p>
                    <p>
                        <a href="{{pending_url}}" target="_blank" class="btn-link" id="pending-link-btn">
                            <button class="btn btn-primary col-8 center-btn" type="button">Pending
                            </button>
                        </a>
                    </p>
                    <p>
                        <a href="{{closed_url}}" target="_blank" class="btn-link" id="closed-link-btn">
                            <button class="btn btn-primary col-6 center-btn" type="button">Closed
                            </button>
                        </a>
                    </p>

                </div>

                <img height="250" class="r-line" src="{% static 'img/line.png' %}" alt="line">


            </div>


        </form>

        <hr class="hr col-12">
            <div class="mt-4 mb-4 d-flex flex-column justify-content-center align-items-center">
                <img src="https://datalabz.re/static/images/interface_logo.png" width="180">
                <a href="https://knowledge.interface.re/fub-embedded-app-documentation" target="_blank"
                    class="text-decoration-underline text-dark mt-2">Learn more about InterFace</a>
            </div>

    </div>



    <script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script>
    <!-- Iconify icons -->
    <script src="https://code.iconify.design/1/1.0.6/iconify.min.js"></script>
    <!-- Bootstrap JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script>
    <script src="https://eia.followupboss.com/embeddedApps-v1.0.0.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="{% static 'js/conditionize.flexible.jquery.js' %}"></script>
    <script src="../../static/js/conditionize.flexible.jquery.js"></script>
    <script>

        function showLoader() {
            document.getElementById('demo').style.display = "none";
            document.getElementById('loader').style.display = "block";
        }
        var timeout;
        function sleep(delay, url) {
            if (timeout) {
                clearTimeout(timeout);
            }
            timeout = setTimeout(function () {
                window.location.href = url;
            }, delay);
        }
        function showLoaderOnClick(url) {
            showLoader();
            sleep(500, url);
        }
        var getUrlParameter = function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
                }
            }
            return false;
        };
        var myModal = new bootstrap.Modal(document.getElementById("opp_modal"), {});

        var number_of_seller_opp = getUrlParameter('number_of_seller_opp');
        var number_of_buyer_opp = getUrlParameter('number_of_buyer_opp');
        var existing_opp_link_seller_uri = getUrlParameter('existing_opp_link_seller');
        var existing_opp_link_seller = JSON.parse(decodeURIComponent(existing_opp_link_seller_uri));
        var existing_opp_link_buyer_uri = getUrlParameter('existing_opp_link_buyer');
        var existing_opp_link_buyer = JSON.parse(decodeURIComponent(existing_opp_link_buyer_uri));


        $(document).ready(function () {
            // links with out client type
            var pipeline_link = $('#pipeline-link-btn').attr("href");
            var appo_set_link = $('#appo-set-link-btn').attr("href");
            var agreement_signed_link = $('#agreement-signed-link-btn').attr("href");
            var pending_link = $('#pending-link-btn').attr("href");
            var closed_link = $('#closed-link-btn').attr("href");

            $('#opp_type').change(function () {
                if ($('#opp_type').val().length > 0) {
                    if (($('#opp_type').val() == 'Buyer' && number_of_buyer_opp >= '1') || ($('#opp_type').val() == 'Seller' && number_of_seller_opp >= '1')) {
                        $('#opp_modal .modal-body p').text('A '+$('#opp_type').val()+' Opportunities already exist are you sure you want to make a new one?');
                        if(($('#opp_type').val() == 'Buyer' && number_of_buyer_opp > '1') || ($('#opp_type').val() == 'Seller' && number_of_seller_opp > '1')){
                            $('#modal-back-btn').html('Take me <br />back to Opportunities');
                        }
                        else{
                            $('#modal-back-btn').html('Take me <br />back to old deal');
                        }

                        myModal.show();
                    }
                    else if($('#opp_type').val() == 'BuyerSeller'){
                        if(number_of_buyer_opp == '0' && number_of_seller_opp == '0'){
                            return;
                        }
                        else if(number_of_buyer_opp >= '1' && number_of_seller_opp >= '1'){
                            $('#modal-back-btn').html('Take me <br />back to Opportunities');
                            myModal.show();
                        }
                        else{
                            if(number_of_buyer_opp > '1'){
                                $('#opp_modal .modal-body p').text('A Buyer Opportunities already exist are you sure you want to make a new one?');
                                $('#modal-back-btn').html('Take me <br />back to Opportunities');
                                myModal.show();
                            }
                            else if(number_of_seller_opp > '1'){
                                $('#opp_modal .modal-body p').text('A Seller Opportunities already exist are you sure you want to make a new one?');
                                $('#modal-back-btn').html('Take me <br />back to Opportunities');
                                myModal.show();
                            }
                            else if(number_of_buyer_opp == '1' || number_of_seller_opp == '1'){
                                $('#modal-back-btn').html('Take me <br />back to old deal');
                                myModal.show();
                            }
                        }
                    }
                }
                // update links with client type
                $('#pipeline-link-btn').attr("href",pipeline_link + '&Field7=' + $('#opp_type').val());
                $('#appo-set-link-btn').attr("href",appo_set_link + '&Field7=' + $('#opp_type').val());
                $('#agreement-signed-link-btn').attr("href", agreement_signed_link + '&Field219=' + $('#opp_type').val());
                $('#pending-link-btn').attr("href", pending_link + '&Field219=' + $('#opp_type').val());
                $('#closed-link-btn').attr("href", closed_link + '&Field219=' + $('#opp_type').val());
            });
            validate();
            $('#opp_type').change(validate);
        });

        function validate() {
            $("button[type=button]").prop("disabled", true);
            $('.btn-link').css('pointer-events','none');
            $(".modal-footer button").prop("disabled", false);
            if ($('#opp_type').val() && $('#opp_type').val().length > 0) {
                if($('#opp_type').val() == 'BuyerSeller'){
                    $("#appo-set-link-btn button[type=button]").prop("disabled", false);
                    $('#appo-set-link-btn').css('pointer-events','all');
                }else{
                    $("button[type=button]").prop("disabled", false);
                    $('.btn-link').css('pointer-events','all');
                }
            }
            else {
                $("button[type=button]").prop("disabled", true);
                $('.btn-link').css('pointer-events','none');
            }
        }

        function existing_opp_redirect() {
            if ($('#opp_type').val() == 'Seller') {
                if(number_of_seller_opp > 1){
                    showLoaderOnClick('{% url 'list_view' %}?context={{context_data}}&signature={{signature}}');
                }
                else{
                    showLoaderOnClick('/common_form/update_wufoo_form?stage=' + existing_opp_link_seller.stage + '&opp_key=' + existing_opp_link_seller.opp_key + '&deal_id=' + existing_opp_link_seller.deal_id + '&team_id=' + existing_opp_link_seller.team_id + '&update_form=1&context={{context_data}}&signature={{signature}}');
                }
            }
            if ($('#opp_type').val() == 'Buyer') {
                if(number_of_buyer_opp > 1){
                    showLoaderOnClick('{% url 'list_view' %}?context={{context_data}}&signature={{signature}}');
                }
                else{
                    showLoaderOnClick('/common_form/update_wufoo_form?stage=' + existing_opp_link_buyer.stage + '&opp_key=' + existing_opp_link_buyer.opp_key + '&deal_id=' + existing_opp_link_buyer.deal_id + '&team_id=' + existing_opp_link_buyer.team_id + '&update_form=1&context={{context_data}}&signature={{signature}}');
                }
            }
            if ($('#opp_type').val() == 'BuyerSeller') {
                if(number_of_buyer_opp > 1){
                    showLoaderOnClick('{% url 'list_view' %}?context={{context_data}}&signature={{signature}}');
                }
                else if(number_of_buyer_opp == 1 && number_of_seller_opp == 0){
                    showLoaderOnClick('/common_form/update_wufoo_form?stage=' + existing_opp_link_buyer.stage + '&opp_key=' + existing_opp_link_buyer.opp_key + '&deal_id=' + existing_opp_link_buyer.deal_id + '&team_id=' + existing_opp_link_buyer.team_id + '&update_form=1&context={{context_data}}&signature={{signature}}');
                }
                if(number_of_seller_opp > 1){
                    showLoaderOnClick('{% url 'list_view' %}?context={{context_data}}&signature={{signature}}');
                }
                else if(number_of_seller_opp == 1 && number_of_buyer_opp == 0){
                    showLoaderOnClick('/common_form/update_wufoo_form?stage=' + existing_opp_link_seller.stage + '&opp_key=' + existing_opp_link_seller.opp_key + '&deal_id=' + existing_opp_link_seller.deal_id + '&team_id=' + existing_opp_link_seller.team_id + '&update_form=1&context={{context_data}}&signature={{signature}}');
                }
                else if(number_of_buyer_opp == 1 && number_of_seller_opp == 1 ){
                    showLoaderOnClick('{% url 'list_view' %}?context={{context_data}}&signature={{signature}}');
                }
            }
        }
    </script>
    <script>
        // To redirect the current page to the previous page
        $(document).on("click", ".btn-link", function(){   
        setTimeout(()=> {
            location.href = document.referrer;
        },5000);   
        });
    </script>

</body>