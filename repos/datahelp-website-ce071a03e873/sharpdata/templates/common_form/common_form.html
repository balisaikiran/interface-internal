<!DOCTYPE html>
{% load static %}

<head>


   <!-- Fonts CDN -->
   <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
   <!-- Bootstrap CDN -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
       integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous" />

  <link
    href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    rel="stylesheet"
  />
  <link
    crossorigin="anonymous"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.css"
    integrity="sha512-63+XcK3ZAZFBhAVZ4irKWe9eorFG0qYsy2CaM5Z+F3kUn76ukznN0cp4SArgItSbDFD1RrrWgVMBY9C/2ZoURA=="
    rel="stylesheet"
  />
  <link
    crossorigin="anonymous"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css"
    integrity="sha512-aEe/ZxePawj0+G2R+AaIxgrQuKT68I28qh+wgLrcAJOz3rxCP+TwrK5SPN+E5I+1IQjNtcfvb96HDagwrKRdBw=="
    rel="stylesheet"
  />
  <link
    crossorigin="anonymous"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker-standalone.css"
    integrity="sha512-2e0Kl/wKgOUm/I722SOPMtmphkIjECJFpJrTRRyL8gjJSJIP2VofmEbqyApMaMfFhU727K3voz0e5EgE3Zf2Dg=="
    rel="stylesheet"
  />
  <link
    crossorigin="anonymous"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker-standalone.min.css"
    integrity="sha512-tjNtfoH+ezX5NhKsxuzHc01N4tSBoz15yiML61yoQN/kxWU0ChLIno79qIjqhiuTrQI0h+XPpylj0eZ9pKPQ9g=="
    rel="stylesheet"
  />
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    rel="stylesheet"
  />

  <style>
    * {
      box-sizing: border-radius;
      font-family: "poppins" !important;
    }

    body {
      font-size: 13px;
      font-family: "poppins" !important;
      min-height: 400px;
       /* Added as bugfix */
      overflow-x: hidden;
	    overflow-y: visible;
    }

    .fs-small {
      font-size: 8px;
    }

    .add-on:hover {
      transform: scale(1.2);
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: ease-out 0.2s;
    }

    :root {
      --background-color: #eeeef5;
      --primary: #065697;
      --primary-hover: #065697;
    }

    .shadow-add {
      box-shadow: 0px 8px 8px rgba(0, 0, 0, 0.2);
    }

    .hrx {
      opacity: 0.1;
    }

    .card-chip:hover {
      box-shadow: 0 0.5rem 0.5rem rgba(0, 0, 0, .15) !important;
      transition: ease-out 0.1s;
    }

    .card-chip {
      cursor: pointer;
    }

    .bd {
      border: solid red 1px !important;
    }

    a {
      cursor: pointer;
    }

    a:hover {
      color: inherit;
    }

    .bg-color-1 {
      background: #F9F9F9;
    }

    .pointer {
      cursor: pointer;
    }

    img {
      object-fit: cover;
    }

    .text-justify {
      text-align: justify;
    }


    .btn-primary {
      background-color: var(--primary);
      font-size: 14px;
      border-color: var(--primary);
      color: #fff;
      outline: none !important;
    }

    .btn-primary:hover,
    .btn-primary:focus,
    .btn-primary:active {
      background-color: transparent;
      border-color: var(--primary-hover);
      color: #065697;
      outline: 0px !important;
    }

    .btn-primary-outline {
      background-color: transparent;
      border-color: var(--primary);
      color: var(--primary);
      outline: 0px !important;
    }

    .btn-primary-outline:hover,
    .btn-primary-outline:focus,
    .btn-primary-outline:active {
      background-color: var(--primary);
      border-color: var(--primary);
      color: #ffffff;
      outline: 0px !important;
    }

    .text-primary {
      color: var(--primary) !important;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    .input-bn {
      font-size: 14px;
      box-sizing: border-box;
      border-radius: 5px !important;
      border: 1.5px solid #8692A6 !important;
      height: 55px !important;
    }

    .input-bn:focus {
      border: 2px solid #065697 !important;
      box-shadow: none;
      background: #FFFFFF;
      box-sizing: border-box;
      border-radius: 6px;
    }

    textarea {
      font-size: 14px;
      box-sizing: border-box;
      border-radius: 5px !important;
      border: 1.5px solid #8692A6 !important;
      min-height: 150px !important;
    }

    textarea:focus {
      border: 2px solid #065697 !important;
      box-shadow: none !important;
      background: #FFFFFF;
      box-sizing: border-box;
      border-radius: 6px;
    }


    .form-floating>.form-control:focus~label,
    .form-floating>.form-control:not(:placeholder-shown)~label,
    .form-floating>.form-select~label {
      opacity: 1 !important;
      color: #808080;
      height: 15px !important;
      padding: 2px !important;
      background: white;
      transform: scale(1) translateY(-0.6rem) translateX(0.85rem) !important;
    }

    .form-floating>.form-control:focus,
    .form-floating>.form-control:not(:placeholder-shown) {
      padding-top: 0.925rem !important;
    }

    .form-floating>.form-select {
      padding-top: 0.925rem !important;
      padding-bottom: 0.625rem;
    }

    .error_message {
      color: red;
    }

    .reqField {
      font-size: 8px;
      color: red;
    }

    .missingField {
      color: red !important;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator {
      background: transparent;
      bottom: 0;
      color: transparent;
      cursor: pointer;
      height: auto;
      left: 0;
      position: absolute;
      right: 0;
      top: 0;
      width: auto;
    }
  </style>

</head>

<body class="bg-white">
  <div id="loader" style="display: none;">
    {% include "common_form/loader.html" %}    
  </div>
  <div id="demo" class="p-4">
    <div class=" d-flex justify-content-between align-items-center" id="back_button">
      <img src="https://fs.hubspotusercontent00.net/hub/21128156/hubfs/Interface-dark-logo.png?width=108&height=108"
        width="45">

      <b class="text-decoration-underline text-dark pointer"><i class="iconify"
          data-icon="material-symbols:arrow-back-rounded"> </i>
          <a
          onclick="showLoaderOnClick('{% url 'list_view' %}?context={{context_data}}&signature={{signature}}')"
        >
        Go back
      </a>
        </b>
    </div>

    <hr class="hr">

    <div class=" mb-4 d-flex justify-content-between align-items-center">
      <b class="fs-6">Create New Opportunities</b>
    </div>
    <form method="POST" id="common_form">
      {% csrf_token %} {% if deal_id %}
      <input hidden name="deal_id" value="{{deal_id}}" />
      <input hidden name="appt_set_entry_id" value="{{appt_set_entry_id}}" />
      <input hidden name="appt_set_lead_type" value="{{appt_set_lead_type}}" />
      <input hidden name="appt_set_platform" value="{{appt_set_platform}}" />
      {% endif %}
      <input hidden name="domain" value="{{domain}}" />
      <div>


        <div class="form-floating mb-3 w-100 form-group">
          <select id="stage_select" class="form-control common-fields select form-select input-bn " name="opp_stage" required>
            <option value="" selected>Select Stage</option>
            <option id="Pipeline" value="Pipeline">Pipeline</option>
            <option id="AppointmentSet" value="Appointment_Set">
              Appointment Set
            </option>
            {% if is_update == 1 %}
            <option id="AppointmentMet" value="Appointment_Met">
              Appointment Met
            </option>
            {% endif %}
            <option id="AgreementSigned" value="Agreement_Signed">
              Agreement Signed
            </option>
            <option id="Pending" value="Pending">Pending</option>
            <option id="Closed" value="Closed">Closed</option>

          </select>
          <label>Stage <i class="iconify text-danger" data-icon="gg:asterisk"></i></label>
        </div>

        <div class="form-floating mb-3 w-100 form-group">
          {% if osa_list %}
          <select class="form-control select common-fields form-select input-bn" name="opp_assigned_osa" required>
          {% else %}
          <select class="form-control select common-fields form-select input-bn" name="opp_assigned_osa">
          {% endif %}

            <option value="" selected>Select OSA</option>
            {% for item in osa_list %}
            <option id="{{item.name}}" value="{{item.name}}">
              {{item.name}}
            </option>
            {% endfor %}

          </select>

          <label>Assigned OSA<i class="iconify text-danger" data-icon="gg:asterisk"></i></label>
        </div>

        <div class="form-floating mb-3 w-100 form-group">
          <textarea class="form-control" placeholder="Description" id="opp_notes" name="opp_notes"></textarea>
          <label>Description</label>
        </div>

        {% if description %}
        <script>
          document.getElementById("opp_notes").value = {{ description }}
        </script>
        {% endif %}

      </div>
      <div id="main_box">
      </div>
      <div class="form-actions form-group mt-3">
        <div id="pendingFields">

        </div>
        <div class="d-flex w-100 justify-content-between">
          <button id="btnSubmit" class="btn btn-primary px-3" type="submit" value="submit">
            Submit
          </button>
        </div>

      </div>

    </form>
  </div>




  <script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script>
   <!-- Iconify icons -->
   <script src="https://code.iconify.design/1/1.0.6/iconify.min.js"></script>
   <!-- Bootstrap JS-->
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
       integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
       crossorigin="anonymous"></script>
  <script
    src="https://eia.followupboss.com/embeddedApps-v1.0.0.js"
    type="text/javascript"
  ></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="{% static 'js/conditionize.flexible.jquery.js' %}"></script>
  <script src="../../static/js/conditionize.flexible.jquery.js"></script>
  


  <script>
    $(function () {
      $(".datePicker").datepicker();
    });
  </script>

  <script>
    /* * * * * * * * * * * * * * * * * *
     * Show/hide fields conditionally
     * * * * * * * * * * * * * * * * * */
    (function ($) {
      $.fn.conditionize = function (options) {
        var settings = $.extend(
          {
            hideJS: true,
          },
          options
        );

        $.fn.showOrHide = function (listenTo, listenFor, $section) {
          if (
            $(listenTo).is("select, input[type=text]") &&
            $(listenTo).val() == listenFor
          ) {
            $section.slideDown();
          } else if ($(listenTo + ":checked").val() == listenFor) {
            $section.slideDown();
          } else {
            $section.slideUp();
          }
        };

        this.each(function () {
          var listenTo = "[name=" + $(this).data("cond-option") + "]";
          var listenFor = $(this).data("cond-value");
          var $section = $(this);

          //Set up event listener
          $(listenTo).on("change", function () {
            $.fn.showOrHide(listenTo, listenFor, $section);
          });
          //If setting was chosen, hide everything first...
          if (settings.hideJS) {
            $(this).hide();
          }
          //Show based on current value on page load
          $.fn.showOrHide(listenTo, listenFor, $section);
        });
      };
    })(jQuery);


    $(document).ready(function () {


      function make_api_call(URL, TYPE, payload = {}) {
        // Summary: Function used for ajax call
        // Parameters: Url : Url for call, Type: POST/GET, Payload
        // Return: Response from the call
        
        return new Promise((resolve, reject) => {
          $.ajax({
            url: URL,
            type: TYPE,
            data: payload,
            success: function (data) {
              console.log(data);
              resolve(data)
            },
            error: function (error) {
              console.log(error);
              reject(error)
            },
          })
        })
      }
      var jsonInput;
      var isa_list = "{{isa_list |safe}}"
      console.log("ISA", isa_list);


      make_api_call("{% url 'common_form_fields' %}", "GET", { "isa_list": isa_list }).then(response => {
      //This will return the dict of fields.
        jsonInput = response;
      });


      function createSelectField(label, name, value = [], required = false) {
        // Function Return HTML of Select field
        var options = "";
        for (v in value) {
          options += `<option value="${value[v]}" >${value[v]}</option>`;
        }
        options += `<option disabled selected value="null">Select</option>`
        var base = `<div class="form-floating mb-3 w-100 form-group ${name} option_fields ${required == 'true' ? "requiredAttr" : ""}">
                        <select class="form-select input-bn form-control" name="${name}" ${required == 'true' ? "required" : ""}>
                          ${options}
                        </select>

                        <label>${label} 
                          ${required == 'true' ? '<i class="iconify text-danger" data-icon="gg:asterisk"></i>' : ''}
                        </label>
                    </div>`;
        return base;
      }

      function createInputField(label, name, type, classes, required = false, step) {
      // Function Return HTML of Input
      // param : Label, Name, Type, classes, required, step:for number of scroll
        var base = `<div class="form-floating mb-3 w-100 form-group ${name} option_fields ${required == 'true' ? "requiredAttr" : ""}">
                      <input 
                        class="form-control input-bn  ${classes}" 
                        placeholder="${label}"
                        name="${name}"
                        step="${step != '' ? step = "any" : ''}"
                        type="${type}"
                      />

                      <label>${label} 
                          ${required == 'true' ? '<i class="iconify text-danger" data-icon="gg:asterisk"></i>' : ''}
                        </label>
                     
                    </div>`;
        return base
      }

      function createTimeField(label, name, required = false, steps = 15) {
        // Function Return HTML of Time Field
        var selectOptions = '<option value="" disabled selected>Select Time</option>';
        var hours, minutes, ampm;
        for (var i = 420; i <= 1320; i += steps) {
          hours = Math.floor(i / 60);
          minutes = i % 60;
          if (minutes < 10) {
            minutes = '0' + minutes; // adding leading zero
          }
          ampm = hours % 24 < 12 ? 'AM' : 'PM';
          hours = hours % 12;
          if (hours === 0) {
            hours = 12;
          }
          selectOptions += `<option value="${hours}:${minutes} ${ampm}">${hours}:${minutes} ${ampm}</option>`;
        }
        var base = `<div class="form-floating mb-3 w-100 form-group ${name} option_fields ${required == 'true' ? "requiredAttr" : ""}">
                      <select class="form-select input-bn form-control" name="${name}">
                        ${selectOptions}
                      </select>
                      <label>
                        ${label} 
                        ${required == 'true' ? '<i class="iconify text-danger" data-icon="gg:asterisk"></i>' : ''}
                      </label>
                    </div>`;

        return base;
      }

      var defaultstates = [{ "United States": { "AK": "Alaska", "AL": "Alabama", "AR": "Arkansas", "AS": "American Samoa", "AZ": "Arizona", "CA": "California", "CO": "Colorado", "CT": "Connecticut", "DC": "District of Columbia", "DE": "Delaware", "FL": "Florida", "GA": "Georgia", "GU": "Guam", "HI": "Hawaii", "IA": "Iowa", "ID": "Idaho", "IL": "Illinois", "IN": "Indiana", "KS": "Kansas", "KY": "Kentucky", "LA": "Louisiana", "MA": "Massachusetts", "MD": "Maryland", "ME": "Maine", "MI": "Michigan", "MN": "Minnesota", "MO": "Missouri", "MP": "Northern Mariana Islands", "MS": "Mississippi", "MT": "Montana", "NA": "National", "NC": "North Carolina", "ND": "North Dakota", "NE": "Nebraska", "NH": "New Hampshire", "NJ": "New Jersey", "NM": "New Mexico", "NV": "Nevada", "NY": "New York", "OH": "Ohio", "OK": "Oklahoma", "OR": "Oregon", "PA": "Pennsylvania", "PR": "Puerto Rico", "RI": "Rhode Island", "SC": "South Carolina", "SD": "South Dakota", "TN": "Tennessee", "TX": "Texas", "UT": "Utah", "VA": "Virginia", "VI": "Virgin Islands", "VT": "Vermont", "WA": "Washington", "WI": "Wisconsin", "WV": "West Virginia", "WY": "Wyoming" } }, { "Canada": { "AB": "Alberta", "BC": "British Columbia", "MB": "Manitoba", "NB": "New Brunswick", "NL": "Newfoundland and Labrador", "NT": "Northwest Territories", "NS": "Nova Scotia", "NU": "Nunavut", "ON": "Ontario", "PE": "Prince Edward Island", "QC": "Quebec", "SK": "Saskatchewan", "YT": "Yukon" } }]

      function createStateField(label, name, states = [], required = false) {
        // Function Return HTML of State from default state list
        var group = "";
        for (i in states) {
          var options = "";
          var obj = states[i];
          Object.keys(obj).map(function (m) {
            Object.keys(obj[m]).map(function (k) {
              options += `<option value="${k}" selected>${obj[m][k]}</option>`;
            })
            group += `<optgroup label="${m}">${options}</optgroup>`;
          })
        }

        group += '<option disabled selected value="null">Select State!</option>';
      
        var base = `<div class="form-group form-floating mb-3 w-100 ${name} option_fields ${required == 'true' ? "requiredAttr" : ""}">
                      <select class="form-select input-bn form-control" name="${name}">
                         ${group}
                      </select>
                      <label>${label} 
                          ${required == 'true' ? '<i class="iconify text-danger" data-icon="gg:asterisk"></i>' : ''}
                      </label>
                    </div>`;

        return base;
      }

      function runJs(js) {
        // This function runs all the javascript through eval.
        setTimeout(() => {
          eval(js)
        }, 700)

      }


    function activateFields(fields = {}) {
        // Function Create Fields according to selected Stage 
        console.log(fields);
        $("#main_box").empty();
        var blocks;
        if (fields) {
          for (sno in fields) {
            if (fields[sno]["type"] == "select") {
              blocks = createSelectField(
                fields[sno]["label"],
                fields[sno]["field"],
                fields[sno]["data"].split(","),
                fields[sno]["required"],
              );
              console.log(fields[sno]["condition"]);
              runJs(fields[sno]["condition"])
            }
            else if (fields[sno]["type"] == "time") {
              blocks = createTimeField(
                fields[sno]["label"],
                fields[sno]["field"],
                fields[sno]["required"],
                30
              );
              runJs(fields[sno]["condition"])
            }
            else if (fields[sno]["type"] == "state") {
              blocks = createStateField(
                fields[sno]["label"],
                fields[sno]["field"],
                defaultstates,
                fields[sno]["required"]
              );
              runJs(fields[sno]["condition"])
            }
            else {
              var dataType;
              var inpType;
              var extraClasses;
              var step = "";
              if (fields[sno]["type"] == "number") {
                console.log("Number");
                dataType = "number";
                step = "any";
                classes = "number-currency"
              }
              else if (fields[sno]["type"] == "date") {
                console.log("date");
                extraClasses = "datePicker"
                dataType = "date";
              }
              else if (fields[sno]["type"] == "tel") {
                console.log("phone");
                dataType = "number";
              }
              else {
                console.log("text");
                dataType = "text";
              }
              blocks = createInputField(
                fields[sno]["label"],
                fields[sno]["field"],
                dataType,
                extraClasses,
                fields[sno]["required"],
                step);
              runJs(fields[sno]["condition"])
            }
            $("#main_box").append(blocks)
          }
        }
      }

      function restAllFields() {
        $(".option_fields").hide();
        $(".option_fields :input").prop("disabled", true);
        $(".option_fields > select").prop("disabled", true);
      }

      $("#stage_select").on("change", function () {
        restAllFields()
        var selected_data = jsonInput[$(this).val()];
        activateFields(fields = selected_data)
      })

      function removeRequiredFromHidden() {
        //Summary: Function removes the required from fields that are hidden.  
        $(".form-group").each((no, atr) => {
          if ($(atr).is(":hidden")) {
            $(atr).find("input").find("select").removeAttr("required")
          }
          else {
            if ($(atr).children("sup").length > 0) {
              $(atr).find("input").find("select").prop("required", "required")
            }
          }
        })
      }


      function onChange(changeClass = "", on = "change", condition = {}, initialHiddenClasses = []) {
        // Summary: Function Create Jquery function which can trigger on events like change, click etc.
        // param: changeClass : Class on which the function to trigger, on: Type on which the function trigger
        // condtion: Accepts dict {} The Key Represent the Class name and 
        // Value Represent the {display:true/false, classes: This classes will be hidden initially}

        var hiddenClasses = "." + initialHiddenClasses.join(', .')
        console.log("hiddenClasses", hiddenClasses);
        $(hiddenClasses).hide();

        condition = JSON.parse(condition);
        if (changeClass && condition) {
          $(changeClass).on(on, function () {
            var $this = $(this).val();
            if (condition.hasOwnProperty($this)) {
              var classes = "." + condition[$this]["classes"].join(', .');
              console.log(condition[$this]["display"]);
              if (condition[$this]["display"] == true) {
                $(classes).show();
              } else $(classes).hide()
            }
          })
        }
        removeRequiredFromHidden();
      }
    })
  </script>
  <script>
    $(document).ready(function () {
      $("#common_form").submit(function (e) {
        var RequireField = []
        // console.log("-------------------------");
        $(".requiredAttr").map(function (x, y) {
          $(y).find("label").removeClass("missingField");
          if ($(y).is(":hidden")) {
            console.warn("HIDDEN FIELD", $(y).find("label").text());
          }
          else {
            if ($(y).find("select").val() == null && $(y).find("select").val() != undefined) {
              $(y).find("label").addClass("missingField");
              RequireField.push($(y).find("label").text());
            }
            if (String($(y).find("input").val()).length == 0) {
              $(y).find("label").addClass("missingField");
              RequireField.push($(y).find("label").text());
            }
          }
        }
        )
        sortedRequireField = RequireField.filter(function (item, pos) {
          return RequireField.indexOf(item) == pos;
        })

        if (sortedRequireField.length > 0) {
          e.preventDefault();
          var err_message = "";
          filterReqFieldName = []
          for (let i of sortedRequireField) {
            i && filterReqFieldName.push(i);
          }

          filterReqFieldName.forEach((i, v) => {
            err_message += `<p><small class="error_message">* ${i} is missing</small></p>`;
          })
          $("#pendingFields").empty();
          $("#pendingFields").append(err_message);
        }
        else {
          $("#btnSubmit").attr("disabled", true);
        }
        return true;
      });
    });
  </script>
  <script>

    function showLoader() {
        document.getElementById('demo').style.display = "none";
        document.getElementById('loader').style.display = "block";
    }
    var timeout;

    function sleep(delay, url) {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(function () {
            window.location.href = url;
        }, delay);
    }

    function showLoaderOnClick(url) {
        showLoader();
        sleep(500, url);
    }
    
</script>

</body>